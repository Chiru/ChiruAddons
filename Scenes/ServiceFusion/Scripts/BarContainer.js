var rdfdata = decodeURIComponent("%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%20%3F%3E%0A%3Crdf%3ARDF%0A%20%20%20xmlns%3Acie%3D%22http%3A//cie/%22%0A%20%20%20xmlns%3Ardf%3D%22http%3A//www.w3.org/1999/02/22-rdf-syntax-ns%23%22%0A%20%20%20xmlns%3Ardfs%3D%22http%3A//www.w3.org/2000/01/rdf-schema%23%22%0A%20%20%20xmlns%3Axsd%3D%22http%3A//www.w3.org/2001/XMLSchema%23%22%0A%20%20%20xmlns%3Aowl%3D%22http%3A//www.w3.org/2002/07/owl%23%22%0A%20%20%20xmlns%3Adc%3D%22http%3A//purl.org/dc/elements/1.1/%22%0A%20%20%20xmlns%3Adcterms%3D%22http%3A//purl.org/dc/terms/%22%0A%20%20%20xmlns%3Avcard%3D%22http%3A//www.w3.org/2001/vcard-rdf/3.0%23%22%3E%0A%0A%3Crdf%3ADescription%20rdf%3Aabout%3D%22http%3A//cie/news%23%22%3E%0A%20%20%20%3Ccie%3Adata-source%3E%3C%21%5BCDATA%5Bhttp%3A//www.djonline.fi/playing/%3Fid%3D118%0A%09%09%5D%5D%3E%3C/cie%3Adata-source%3E%0A%20%20%20%3Ccie%3Asource-application%3Emusic%3C/cie%3Asource-application%3E%0A%20%20%20%3Ccie%3Adata%3EDjOnline%20-%201bar%20Oulu%3C/cie%3Adata%3E%0A%20%20%20%3Ccie%3Ametadata%3Etitle%3C/cie%3Ametadata%3E%0A%20%20%20%3Ccie%3Adata%3E%3C%21%5BCDATA%5B11%3A50%3A18%20Black%20Sabbath%20-%20Paranoid%20%28The%20Tek-One%20Dubstep%202010%20Remix%29%5D%5D%3E%3C/cie%3Adata%3E%0A%20%20%20%3Ccie%3Ametadata%3Ecurrent%3C/cie%3Ametadata%3E%0A%20%20%20%3Ccie%3Ageo%3E3.0002859556335%2C-15.768386702218%2C32.134019608241%3C/cie%3Ageo%3E%0A%20%20%20%3Ccie%3Ageo%3EKauppurienkatu%205%2C%2090100%20Oulu%3C/cie%3Ageo%3E%0A%20%20%20%3Ccie%3Adatetime%20rdf%3Adatatype%3D%22http%3A//www.w3.org/2001/XMLSchema%23dateTime%22%3E2012-06-19T11%3A55%3A00%2B03%3A00%3C/cie%3Adatetime%3E%0A%3C/rdf%3ADescription%3E%0A%0A%3C/rdf%3ARDF%3E%20%0A%0A%0A%0A")
var rdfdata2 = decodeURIComponent('%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%20%3F%3E%0A%3Crdf%3ARDF%0A%20%20%20xmlns%3Acie%3D%22http%3A//cie/%22%0A%20%20%20xmlns%3Ardf%3D%22http%3A//www.w3.org/1999/02/22-rdf-syntax-ns%23%22%0A%20%20%20xmlns%3Ardfs%3D%22http%3A//www.w3.org/2000/01/rdf-schema%23%22%0A%20%20%20xmlns%3Axsd%3D%22http%3A//www.w3.org/2001/XMLSchema%23%22%0A%20%20%20xmlns%3Aowl%3D%22http%3A//www.w3.org/2002/07/owl%23%22%0A%20%20%20xmlns%3Adc%3D%22http%3A//purl.org/dc/elements/1.1/%22%0A%20%20%20xmlns%3Adcterms%3D%22http%3A//purl.org/dc/terms/%22%0A%20%20%20xmlns%3Avcard%3D%22http%3A//www.w3.org/2001/vcard-rdf/3.0%23%22%3E%0A%0A%3Crdf%3ADescription%20rdf%3Aabout%3D%22http%3A//cie/news%23%22%3E%0A%20%20%20%3Ccie%3Adata-source%3Ehttp%3A//www.djonline.fi/playing/%3Fid%3D118%3C/cie%3Adata-source%3E%0A%20%20%20%3Ccie%3Asource-application%3Emusic%3C/cie%3Asource-application%3E%0A%20%20%20%3Ccie%3Adata%3EDjOnline%20-%201bar%20Oulu%3C/cie%3Adata%3E%0A%20%20%20%3Ccie%3Ametadata%3Etitle%3C/cie%3Ametadata%3E%0A%20%20%20%3Ccie%3Adata%3E14%3A55%3A00%20Adele%20-%20Crazy%20For%20You%3C/cie%3Adata%3E%0A%20%20%20%3Ccie%3Ametadata%3Ecurrent%3C/cie%3Ametadata%3E%0A%20%20%20%3Ccie%3Ageo%3E3.0002859556335%2C-15.768386702218%2C32.134019608241%3C/cie%3Ageo%3E%0A%20%20%20%3Ccie%3Ageo%3EKauppurienkatu%205%2C%2090100%20Oulu%3C/cie%3Ageo%3E%0A%20%20%20%3Ccie%3Adatetime%20rdf%3Adatatype%3D%22http%3A//www.w3.org/2001/XMLSchema%23dateTime%22%3E2012-06-20T15%3A29%3A41%2B03%3A00%3C/cie%3Adatetime%3E%0A%3C/rdf%3ADescription%3E%0A%0A%3C/rdf%3ARDF%3E%20')
// print("using rdf: " + rdfdata);
engine.ImportExtension("qt.core");
engine.ImportExtension("qt.gui");
engine.ImportExtension("qt.network");
engine.IncludeFile("RdfVocabulary.js");
engine.IncludeFile("VisualContainerUtils.js");
engine.IncludeFile("Lyrics.js");

ui.MainWindow().mouseTracking = true;  

function Song()
{
    this.title = "";
    this.time = null;
}

Song.IsEmpty = function()
{
    if (this.title == "" && this.time == null) 
        return true;
    return false;
};

var last_song = null; // updated from Song.FromString

// me.Action("ShowLyrics").Triggered.connect(function(type, rdfStoreData) {
//     print("starting lyrics fetch");
//     GetSongLyrics(last_song, function(song, lyrics) {
// 	print("got lyrics in barcontainer");
// 	if (!label2)
// 	    print("no label2");
// 	else {
// 	    label2.text = lyrics;
// 	}
//     });
// });

// Construct a song struct from the string, if parse fails null object is returned.
Song.FromString = function(data)
{
    print("fromstring: got data: " + data);
    var re = /(\d\d:\d\d:\d\d)\s+([^-]+) - ([^\)\(]*)/;
    var matchinfo = re.exec(data);
    if (!matchinfo)
	return null;
    song = new Song();
    song.time = matchinfo[1].trim();
    song.artist = matchinfo[2].trim();
    song.title = matchinfo[3].trim();
    me.dynamiccomponent.CreateAttribute("qvariant", "last_song");
    me.dynamiccomponent.SetAttribute("last_song", song);
    // me.dynamiccomponent.CreateAttribute("string", "last_song_title");
    // me.dynamiccomponent.SetAttribute("last_song_title", song.title);
    print("dc: " + me.dynamiccomponent.GetAttribute("last_song").artist);
    last_song = song;
    
    return song;
};

function SongContainer(parent)
{
    BaseContainer.call(this, parent);
    print("SongContainer init");
    this.songs = new Array();
    this.visual.size = new QSize(320, 400);
    me.graphicsviewcanvas.width = this.visual.width;
    me.graphicsviewcanvas.height = this.visual.height;
    this.visual.setLayout(new QVBoxLayout());
    this.visual.layout().setContentsMargins(0, 0, 0, 0);
    this.visual.layout().setSpacing(0);
    
    var world    = RdfModule.theWorld;
    var request  = new HttpRequest();
    var djonline_1bar_url = "http://www.djonline.fi/playing/?id=118";
    var djonline_ottok_url = "http://www.djonline.fi/playing/?id=487";
    request.operation = QNetworkAccessManager.GetOperation;
    print("Starting http req");
    var response = ScriptServices.SendPreprocessorRequest(
	"http://hq.ludocraft.com/ludowww/cie/bar.php",
	djonline_ottok_url, request); 
    
    response.Ready.connect(this, function(response)
    {
	// XXX mock data
	print("http response data: " + rdfdata);
        if (this.visual.owner.rdfStore.FromString(rdfdata))
	// print("http response data: " + response.data.toString());
        // if (this.visual.owner.rdfStore.FromString(response.data))

        {
            // Create query statement.
            var subject = world.CreateResource(new QUrl("http://cie/news#"));
            var predicate = world.CreateResource(new QUrl(RdfVocabulary.data));
            var statement = world.CreateStatement(subject, predicate, null);
            
            var statements = this.visual.owner.rdfStore.Select(statement); 
            
            world.FreeNode(subject);
            world.FreeNode(predicate);
            world.FreeStatement(statement);
            
            // Parse each statment to song object.
            var song = null;
            var currentTime = new Date();
            for(var i = 0; i < statements.length; ++i)
            {
                song = Song.FromString(statements[i].object.literal.toString());
		if (!song)
		    continue;
                //if (song && song.time > currentTime.getTime())
                this.songs.push(song);
		print("pushing song " + song.title);
                world.FreeStatement(statements[i]);
            }
            
            var displayCount = 5;
            for (var i = 0; i < this.songs.length; ++i)
            {
                if (i < displayCount)
                    this.DisplaySong(this.songs[i]);
                else
                    break;
            }
        }
        response.deleteLater();
        response = null;
    });
}
SongContainer.prototype = new BaseContainer();

// Create VisualContainer object for single song and add it as child to SongContainer object.

var label2 = null;
var label = null;

SongContainer.prototype.DisplaySong = function(song) 
{

    // actually we get the lyrics here since there seems to be no
    // mechanism to pass the parsed song objects out?

    print("displaysong " + song.title);
    var main = new QWidget();
    main.setLayout(new QHBoxLayout());
    main.setSizePolicy (QSizePolicy.Expanding, QSizePolicy.Preffered);
    main.layout().setContentsMargins(10, 0, 0, 0); 
    main.objectName = "Song";
    
    var songVisual = CreateVisualContainer(main, new QHBoxLayout(), this.visual);
    
    // Fill tag infomation to given song container.
    // Note! AddStatement function is defined in VisualContainerUtils.js file.
    AddStatement(songVisual, RdfVocabulary.baseUri, RdfVocabulary.sourceApplication, "Song");
    AddStatement(songVisual, RdfVocabulary.baseUri, RdfVocabulary.data, song.title);
    AddStatement(songVisual, RdfVocabulary.baseUri, RdfVocabulary.data, song.artist.toString());
    
    // Initialize time Label 
    var timeStr = song.time;
    // label = new QLabel(timeStr); 
    // label.font = new QFont("FreeSans", 14);
    // label.alignment = 0x0001 | 0x0020; // Qt::AlignLeft | Qt::AlignTop
    // main.layout().addWidget(label, null, null);
    
    // Initialize title Label 
    label2 = new QLabel(song.title);
    label2.font = new QFont("FreeSans", 12);
    label2.setSizePolicy (QSizePolicy.Expanding, QSizePolicy.Preffered);
    main.layout().addWidget(label2, null, null);
    
    var line = CreateHLine();
    songVisual.layout().addWidget(line, 0, 0);
    
    songVisual.layout().addWidget(main, null, null); 
    songVisual.layout().spacing = 0;
    songVisual.setContentsMargins(0, 0, 0, 0);
}

function CreateContainer(entity)
{
    var container = new SongContainer(null)
    entity.graphicsviewcanvas.GraphicsScene().addWidget(container.visual);
    //print(entity.graphicsviewcanvas.GraphicsView().childrenRegion.boundingRect());
    return container;
}

var container = CreateContainer(me);

function OnScriptDestroyed()
{
    if (framework.IsExiting())
        return; // Application shutting down, the widget pointers are garbage.
    if (container)
    {
        container.visual.deleteLater();
        container = null;
    }
}
